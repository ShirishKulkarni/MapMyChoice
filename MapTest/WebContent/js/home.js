//<![CDATA[

jsonData = '{"cities":[{"city": "ACMAR", "loc": [-86.51557, 33.584132], "pop": 6055, "state": "AL", "_id": "35004"},'
		+ '{"city": "ADAMSVILLE", "loc": [-86.959727, 33.588437], "pop": 10616, "state": "AL", "_id": "35005"},'
		+ '{"city": "ADGER", "loc": [-87.167455, 33.434277], "pop": 3205, "state": "AL", "_id": "35006"},'
		+ '{"city": "KEYSTONE", "loc": [-86.812861, 33.236868], "pop": 14218, "state": "AL", "_id": "35007"},'
		+ '{"city": "NEW SITE", "loc": [-85.951086, 32.941445], "pop": 19942, "state": "AL", "_id": "35010"},'
		+ '{"city": "ALPINE", "loc": [-86.208934, 33.331165], "pop": 3062, "state": "AL", "_id": "35014"},'
		+ '{"city": "ARAB", "loc": [-86.489638, 34.328339], "pop": 13650, "state": "AL", "_id": "35016"},'
		+ '{"city": "BAILEYTON", "loc": [-86.621299, 34.268298], "pop": 1781, "state": "AL", "_id": "35019"},'
		+ '{"city": "BESSEMER", "loc": [-86.947547, 33.409002], "pop": 40549, "state": "AL", "_id": "35020"},'
		+ '{"city": "HUEYTOWN", "loc": [-86.999607, 33.414625], "pop": 39677, "state": "AL", "_id": "35023"},'
		+ '{"city": "BLOUNTSVILLE", "loc": [-86.568628, 34.092937], "pop": 9058, "state": "AL", "_id": "35031"},'
		+ '{"city": "BREMEN", "loc": [-87.004281, 33.973664], "pop": 3448, "state": "AL", "_id": "35033"},'
		+ '{"city": "BRENT", "loc": [-87.211387, 32.93567], "pop": 3791, "state": "AL", "_id": "35034"},'
		+ '{"city": "BRIERFIELD", "loc": [-86.951672, 33.042747], "pop": 1282, "state": "AL", "_id": "35035"},'
		+ '{"city": "CALERA", "loc": [-86.755987, 33.1098], "pop": 4675, "state": "AL", "_id": "35040"},'
		+ '{"city": "CENTREVILLE", "loc": [-87.11924, 32.950324], "pop": 4902, "state": "AL", "_id": "35042"},'
		+ '{"city": "CHELSEA", "loc": [-86.614132, 33.371582], "pop": 4781, "state": "AL", "_id": "35043"},'
		+ '{"city": "COOSA PINES", "loc": [-86.337622, 33.266928], "pop": 7985, "state": "AL", "_id": "35044"},'
		+ '{"city": "CLANTON", "loc": [-86.642472, 32.835532], "pop": 13990, "state": "AL", "_id": "35045"},'
		+ '{"city": "CLEVELAND", "loc": [-86.559355, 33.992106], "pop": 2369, "state": "AL", "_id": "35049"},'
		+ '{"city": "COLUMBIANA", "loc": [-86.616145, 33.176964], "pop": 4486, "state": "AL", "_id": "35051"},'
		+ '{"city": "CRANE HILL", "loc": [-87.048395, 34.082117], "pop": 2270, "state": "AL", "_id": "35053"},'
		+ '{"city": "CROPWELL", "loc": [-86.280026, 33.506448], "pop": 4171, "state": "AL", "_id": "35054"},'
		+ '{"city": "CULLMAN", "loc": [-86.829777, 34.176146], "pop": 31708, "state": "AL", "_id": "35055"},'
		+ '{"city": "BRUCE", "loc": [-91.290622, 45.447923], "pop": 2654, "state": "WI", "_id": "54819"},'
		+ '{"city": "BRULE", "loc": [-91.553862, 46.576318], "pop": 902, "state": "WI", "_id": "54820"},'
		+ '{"city": "CABLE", "loc": [-91.224438, 46.217155], "pop": 1311, "state": "WI", "_id": "54821"},'
		+ '{"city": "CAMERON", "loc": [-91.730992, 45.403836], "pop": 3314, "state": "WI", "_id": "54822"},'
		+ '{"city": "CENTURIA", "loc": [-92.547741, 45.448369], "pop": 1791, "state": "WI", "_id": "54824"},'
		+ '{"city": "COMSTOCK", "loc": [-92.085961, 45.491114], "pop": 473, "state": "WI", "_id": "54826"},'
		+ '{"city": "CORNUCOPIA", "loc": [-91.097421, 46.837171], "pop": 242, "state": "WI", "_id": "54827"},'
		+ '{"city": "ROUND HILL", "loc": [-77.783305, 39.113378], "pop": 1926, "state": "VA", "_id": "22141"},'
		+ '{"city": "SPRINGFIELD", "loc": [-77.186582, 38.779718], "pop": 16811, "state": "VA", "_id": "22150"},'
		+ '{"city": "NORTH SPRINGFIEL", "loc": [-77.213908, 38.803323], "pop": 15979, "state": "VA", "_id": "22151"},'
		+ '{"city": "WEST SPRINGFIELD", "loc": [-77.233243, 38.776488], "pop": 26803, "state": "VA", "_id": "22152"},'
		+ '{"city": "SPRINGFIELD", "loc": [-77.237026, 38.744859], "pop": 32161, "state": "VA", "_id": "22153"},'
		+ '{"city": "STERLING", "loc": [-77.398624, 39.02147], "pop": 38891, "state": "VA", "_id": "22170"},'
		+ '{"city": "THE PLAINS", "loc": [-77.772092, 38.87393], "pop": 2071, "state": "VA", "_id": "22171"},'
		+ '{"city": "TRIANGLE", "loc": [-77.322877, 38.550894], "pop": 5181, "state": "VA", "_id": "22172"},'
		+ '{"city": "UPPERVILLE", "loc": [-77.848438, 39.008747], "pop": 755, "state": "VA", "_id": "22176"},'
		+ '{"city": "VIENNA", "loc": [-77.253219, 38.893527], "pop": 20795, "state": "VA", "_id": "22180"},'
		+ '{"city": "VIENNA", "loc": [-77.288048, 38.897695], "pop": 12462, "state": "VA", "_id": "22181"},'
		+ '{"city": "VIENNA", "loc": [-77.264876, 38.928005], "pop": 19121, "state": "VA", "_id": "22182"},'
		+ '{"city": "AIRLIE", "loc": [-77.764809, 38.72593], "pop": 24248, "state": "VA", "_id": "22186"},'
		+ '{"city": "WATERFORD", "loc": [-77.642134, 39.208102], "pop": 264, "state": "VA", "_id": "22190"},'
		+ '{"city": "ALBANY", "loc": [-72.34181, 44.734427], "pop": 782, "state": "VT", "_id": "05820"},'
		+ '{"city": "BARNET", "loc": [-72.078326, 44.317923], "pop": 1415, "state": "VT", "_id": "05821"},'
		+ '{"city": "BARTON", "loc": [-72.160005, 44.739465], "pop": 1270, "state": "VT", "_id": "05822"},'
		+ '{"city": "CONCORD", "loc": [-71.867554, 44.446055], "pop": 1242, "state": "VT", "_id": "05824"},'
		+ '{"city": "COVENTRY", "loc": [-72.254471, 44.880853], "pop": 722, "state": "VT", "_id": "05825"},'
		+ '{"city": "CRAFTSBURY", "loc": [-72.366007, 44.64341], "pop": 623, "state": "VT", "_id": "05826"},'
		+ '{"city": "CRAFTSBURY COMMO", "loc": [-72.414578, 44.652917], "pop": 399, "state": "VT", "_id": "05827"},'
		+ '{"city": "DANVILLE", "loc": [-72.113319, 44.433241], "pop": 1482, "state": "VT", "_id": "05828"},'
		+ '{"city": "DERBY", "loc": [-72.137555, 44.950182], "pop": 2607, "state": "VT", "_id": "05829"},'
		+ '{"city": "DERBY LINE", "loc": [-72.082367, 44.990183], "pop": 2040, "state": "VT", "_id": "05830"},'
		+ '{"city": "EAST BURKE", "loc": [-71.935674, 44.607849], "pop": 875, "state": "VT", "_id": "05832"},'
		+ '{"city": "EAST CHARLESTON", "loc": [-71.97627, 44.829896], "pop": 246, "state": "VT", "_id": "05833"},'
		+ '{"city": "EAST HARDWICK", "loc": [-72.303351, 44.528833], "pop": 493, "state": "VT", "_id": "05836"},'
		+ '{"city": "EAST HAVEN", "loc": [-71.867491, 44.651724], "pop": 269, "state": "VT", "_id": "05837"},'
		+ '{"city": "GLOVER", "loc": [-72.203819, 44.719979], "pop": 795, "state": "VT", "_id": "05839"},'
		+ '{"city": "GREENSBORO", "loc": [-72.285017, 44.595069], "pop": 461, "state": "VT", "_id": "05841"},'
		+ '{"city": "GREENSBORO BEND", "loc": [-72.252478, 44.548488], "pop": 405, "state": "VT", "_id": "05842"},'
		+ '{"city": "HARDWICK", "loc": [-72.363818, 44.507026], "pop": 2450, "state": "VT", "_id": "05843"},'
		+ '{"city": "IRASBURG", "loc": [-72.276269, 44.808056], "pop": 907, "state": "VT", "_id": "05845"},'
		+ '{"city": "MANTI", "loc": [-111.651372, 39.235389], "pop": 3088, "state": "UT", "_id": "84642"},'
		+ '{"city": "MONA", "loc": [-111.848001, 39.838165], "pop": 826, "state": "UT", "_id": "84645"},'
		+ '{"city": "MOUNT PLEASANT", "loc": [-111.503854, 39.523227], "pop": 4979, "state": "UT", "_id": "84647"},'
		+ '{"city": "NEPHI", "loc": [-111.8359, 39.692275], "pop": 4200, "state": "UT", "_id": "84648"},'
		+ '{"city": "OASIS", "loc": [-112.648079, 39.27067], "pop": 500, "state": "UT", "_id": "84650"},'
		+ '{"city": "EL PASO", "loc": [-106.440569, 31.786213], "pop": 20768, "state": "TX", "_id": "79903"},'
		+ '{"city": "EL PASO", "loc": [-106.438135, 31.853334], "pop": 35732, "state": "TX", "_id": "79904"},'
		+ '{"city": "EL PASO", "loc": [-106.430445, 31.767447], "pop": 32865, "state": "TX", "_id": "79905"},'
		+ '{"city": "FORT BLISS", "loc": [-106.421611, 31.807631], "pop": 11364, "state": "TX", "_id": "79906"},'
		+ '{"city": "EL PASO", "loc": [-106.329281, 31.708908], "pop": 58052, "state": "TX", "_id": "79907"},'
		+ '{"city": "FORT BLISS", "loc": [-106.386711, 31.82753], "pop": 2918, "state": "TX", "_id": "79908"},'
		+ '{"city": "EL PASO", "loc": [-106.536433, 31.838309], "pop": 46537, "state": "TX", "_id": "79912"},'
		+ '{"city": "EL PASO", "loc": [-106.368605, 31.743234], "pop": 46356, "state": "TX", "_id": "79915"},'
		+ '{"city": "FORT BLISS", "loc": [-106.159157, 31.794873], "pop": 6703, "state": "TX", "_id": "79916"},'
		+ '{"city": "EL PASO", "loc": [-106.573176, 31.821767], "pop": 8540, "state": "TX", "_id": "79922"},'
		+ '{"city": "EL PASO", "loc": [-106.414857, 31.902098], "pop": 57215, "state": "TX", "_id": "79924"},'
		+ '{"city": "EL PASO", "loc": [-106.361317, 31.781402], "pop": 41235, "state": "TX", "_id": "79925"},'
		+ '{"city": "HORIZON CITY", "loc": [-106.273064, 31.653014], "pop": 30011, "state": "TX", "_id": "79927"},'
		+ '{"city": "EL PASO", "loc": [-106.456754, 31.804795], "pop": 29792, "state": "TX", "_id": "79930"},'
		+ '{"city": "EL PASO", "loc": [-106.593186, 31.862334], "pop": 14909, "state": "TX", "_id": "79932"},'
		+ '{"city": "PAYSON", "loc": [-111.732138, 40.044866], "pop": 13960, "state": "UT", "_id": "84651"},'
		+ '{"city": "WOODLAND HILLS", "loc": [-111.65906, 40.042702], "pop": 3766, "state": "UT", "_id": "84653"},'
		+ '{"city": "SALINA", "loc": [-111.881072, 38.956028], "pop": 3716, "state": "UT", "_id": "84654"},'
		+ '{"city": "GENOLA", "loc": [-111.793819, 39.980356], "pop": 3647, "state": "UT", "_id": "84655"},'
		+ '{"city": "WARRINGTON", "loc": [-75.135392, 40.246438], "pop": 13862, "state": "PA", "_id": "18976"},'
		+ '{"city": "WASHINGTON CROSS", "loc": [-74.882859, 40.291906], "pop": 2824, "state": "PA", "_id": "18977"},'
		+ '{"city": "OGONTZ CAMPUS", "loc": [-75.128918, 40.128141], "pop": 17302, "state": "PA", "_id": "19001"},'
		+ '{"city": "MAPLE GLEN", "loc": [-75.207234, 40.166318], "pop": 24133, "state": "PA", "_id": "19002"},'
		+ '{"city": "ARDMORE", "loc": [-75.29665, 40.001971], "pop": 12443, "state": "PA", "_id": "19003"},'
		+ '{"city": "BALA CYNWYD", "loc": [-75.23421, 40.01179], "pop": 9239, "state": "PA", "_id": "19004"},'
		+ '{"city": "HUNTINGDON VALLE", "loc": [-75.058979, 40.129686], "pop": 19866, "state": "PA", "_id": "19006"},'
		+ '{"city": "TULLYTOWN", "loc": [-74.860718, 40.109174], "pop": 22334, "state": "PA", "_id": "19007"},'
		+ '{"city": "BROOMALL", "loc": [-75.360214, 39.974666], "pop": 20432, "state": "PA", "_id": "19008"},'
		+ '{"city": "BRYN MAWR", "loc": [-75.329487, 40.023618], "pop": 21826, "state": "PA", "_id": "19010"},'
		+ '{"city": "CHELTENHAM", "loc": [-75.104774, 40.060327], "pop": 6912, "state": "PA", "_id": "19012"},'
		+ '{"city": "CHESTER", "loc": [-75.374687, 39.849817], "pop": 49144, "state": "PA", "_id": "19013"},'
		+ '{"city": "ROCKY POINT", "loc": [-77.923448, 34.434418], "pop": 4657, "state": "NC", "_id": "28457"},'
		+ '{"city": "ROSE HILL", "loc": [-78.016624, 34.823462], "pop": 4421, "state": "NC", "_id": "28458"},'
		+ '{"city": "SHALLOTTE", "loc": [-78.41068, 33.943011], "pop": 6537, "state": "NC", "_id": "28459"},'
		+ '{"city": "SNEADS FERRY", "loc": [-77.403801, 34.542589], "pop": 4586, "state": "NC", "_id": "28460"},'
		+ '{"city": "BOILING SPRING L", "loc": [-78.045551, 34.012137], "pop": 8878, "state": "NC", "_id": "28461"},'
		+ '{"city": "HOLDEN BEACH", "loc": [-78.296089, 33.962504], "pop": 7513, "state": "NC", "_id": "28462"},'
		+ '{"city": "TABOR CITY", "loc": [-78.823178, 34.123314], "pop": 6573, "state": "NC", "_id": "28463"},'
		+ '{"city": "TEACHEY", "loc": [-78.022091, 34.770036], "pop": 1461, "state": "NC", "_id": "28464"},'
		+ '{"city": "OAK ISLAND", "loc": [-78.125455, 33.916122], "pop": 4752, "state": "NC", "_id": "28465"},'
		+ '{"city": "PHOENIX", "loc": [-112.246763, 33.491278], "pop": 13924, "state": "AZ", "_id": "85037"},'
		+ '{"city": "WALLACE", "loc": [-77.942922, 34.754166], "pop": 7328, "state": "NC", "_id": "28466"},'
		+ '{"city": "CALABASH", "loc": [-78.574406, 33.904668], "pop": 3061, "state": "NC", "_id": "28467"},'
		+ '{"city": "SUNSET BEACH", "loc": [-78.519955, 33.883569], "pop": 1347, "state": "NC", "_id": "28468"},'
		+ '{"city": "OCEAN ISLE BEACH", "loc": [-78.429849, 33.891271], "pop": 493, "state": "NC", "_id": "28469"},'
		+ '{"city": "WATHA", "loc": [-78.007351, 34.620725], "pop": 1327, "state": "NC", "_id": "28471"},'
		+ '{"city": "WHITEVILLE", "loc": [-78.716048, 34.324142], "pop": 18066, "state": "NC", "_id": "28472"},'
		+ '{"city": "WILLARD", "loc": [-78.023445, 34.684451], "pop": 2456, "state": "NC", "_id": "28478"},'
		+ '{"city": "WINNABOW", "loc": [-78.056211, 34.214511], "pop": 3084, "state": "NC", "_id": "28479"},'
		+ '{"city": "WRIGHTSVILLE BEA", "loc": [-77.798166, 34.212228], "pop": 2928, "state": "NC", "_id": "28480"},'
		+ '{"city": "PHOENIX", "loc": [-112.246763, 33.491278], "pop": 13924, "state": "AZ", "_id": "85037"}]}';

$('#imageData').css('display', 'none');
var parsedJson = $.parseJSON(jsonData);
var citiesArray = parsedJson.cities;
var redCount = 0;
var yellowCount = 0;
var greenCount = 0;
var redColorPlaces = "";
var yellowColorPlaces = "";
var greenColorPlaces = "";
var legendSelected = "";
var redMarkersArray = new Array();
var yellowMarkersArray = new Array();
var greenMarkersArray = new Array();
var locTemp = null;
var point = null;
var marker = null;
var bff = 0;
var retailTypes = new Array();
var status = 0;
var countRetailsStores = 0;
var retailTypeObject = null;
var storeMarkerArray = new Array();
var storeDetailArray = new Array();
var page = 'home';
var retailTypes = new Array();
var myZipCode = '';
var storeCodeArray = new Array();
if (GBrowserIsCompatible()) {

	/*
	 * Fetch the store details from Store REference API
	 */
	// var tempResp = getStoreDetailsGivenStoreCode(790167);
	// alert(tempResp);
	function getStoreDetailsGivenStoreCode(storeCode) {
		// storeCode=790167;
		var jsonResp = '';
		$.ajax({
			url : "https://nielsen.api.tibco.com/Stores/v1/" + storeCode,
			contentType : "application/json",
			headers : {
				"User-Agent" : "Shred",
				"Accept" : "application/json",
				"Apikey" : "8097-c6986dfe-018d-455e-8177-279cafb64e5a"
			},
			async : false,
			cache : false,
			crossDomain : true,
			success : function(response) {

				jsonResp = JSON.stringify(response);
				// alert(jsonResp);

			},
			error : function(error) {

				alert(error.statusText);

			}

		});
		return jsonResp;
	}

	/*
	 * var xStoreData = getAllStoresInZip(10001); var storeCodeArray = new
	 * Array(); storeCodeArray = getStoreCodeFromJson(xStoreData); //
	 * alert(storeCodeArray); var storeDetailArray = new Array(); var obj =
	 * null; var storDetail; for (var i = 0; i < storeCodeArray.length; i++) {
	 * //alert(storeCodeArray[i]); storDetail =
	 * getStoreDetailsGivenStoreCode(storeCodeArray[i]); //alert('Before
	 * parsing'); obj = $.parseJSON(storDetail);
	 * //alert(JSON.stringify(obj.StoreInfo.Characteristics[0].LATITUDE));
	 * storeDetailArray.push(obj.StoreInfo.Characteristics[0].LATITUDE);
	 * //alert(storeDetailArray); }
	 */
	function getStoreCodeFromJson(storeDataJson) {
		var xStoreCodeArray = new Array();
		// alert(storeDataJson['StoreRefData'].Stores);
		$.each(storeDataJson['StoreRefData'].Stores, function(i, item) {
			xStoreCodeArray.push(item.StoreCode);
		});
		// alert(storeDataJson.StoreRefData.Stores);
		return xStoreCodeArray;
	}

	function getAllStoresInZip(zip) {
		//alert('getAllStoresInZip');
		var jsonResp = '';
		$.ajax({
			url : "https://nielsen.api.tibco.com/Stores/v1/Location?zipcode="
					+ zip + "&pagesize=25",
			contentType : "application/json",
			headers : {
				"User-Agent" : "Shred",
				"Accept" : "application/json",
				"Apikey" : "8097-c6986dfe-018d-455e-8177-279cafb64e5a"
			},
			async : false,
			cache : false,
			crossDomain : true,
			success : function(response) {

				jsonResp = response;
				// alert(jsonResp);

			},
			error : function(error) {

				alert(error.statusText);

			}

		});
		return jsonResp;
	}

	// Create our "tiny" marker icon
	var redIcon = new GIcon(G_DEFAULT_ICON);
	redIcon.image = "http://maps.google.com/mapfiles/kml/paddle/red-blank.png";

	// Create our "tiny" marker icon
	var yellowIcon = new GIcon(G_DEFAULT_ICON);
	yellowIcon.image = "http://maps.google.com/mapfiles/kml/paddle/blu-blank.png";

	// Create our "tiny" marker icon
	var greenIcon = new GIcon(G_DEFAULT_ICON);
	greenIcon.image = "http://maps.google.com/mapfiles/kml/paddle/grn-blank.png";

	// Create our "tiny" marker icon
	var storeIcon = new GIcon(G_DEFAULT_ICON);
	storeIcon.image = "http://maps.google.com/mapfiles/kml/pal3/icon31.png";

	// Set up our GMarkerOptions object
	markerRedOptions = {
		icon : redIcon
	};
	// Set up our GMarkerOptions object
	markerYellowOptions = {
		icon : yellowIcon
	};
	// Set up our GMarkerOptions object
	markerGreenOptions = {
		icon : greenIcon
	};

	markerStoreOptions = {
		icon : storeIcon
	}

	// this variable will collect the html which will eventually be placed in
	// the side_bar
	var side_bar_html = "";

	// arrays to hold copies of the markers and html used by the side_bar
	// because the function closure trick doesnt work there
	var gmarkers = [];

	// create the map
	var map = new GMap2(document.getElementById("map"));
	map.addControl(new GLargeMapControl());
	map.addControl(new GMapTypeControl());
	map.setCenter(new GLatLng(35.889311, -101.090012), 4);

	function createStoreMarker(point, name, html, markerOptions, color) {
		var marker = new GMarker(point, markerOptions);
		
		// save the info we need to use later for the side_bar
		gmarkers.push(marker);
		GEvent.addListener(marker, "click", function() {
			marker.openInfoWindowHtml(html);
		});
		
		return marker;
	}

	// A function to create the marker and set up the event window
	function createMarker(point, name, html, markerOptions, color, lat, lon,
			zipcode, pop) {
		var marker = new GMarker(point, markerOptions);
		marker.pop = pop;

		// save the info we need to use later for the side_bar
		gmarkers.push(marker);
		// add a line to the side_bar html

		if (color == "red") {
			redColorPlaces += '<a class="placeData" style=color:' + color
					+ ' href="javascript:myclick(' + (gmarkers.length - 1)
					+ ',' + lat + ',' + lon + ')">' + name + '<\/a><br>';
		} else if (color == "blue") {
			yellowColorPlaces += '<a class="placeData" style=color:' + color
					+ ' href="javascript:myclick(' + (gmarkers.length - 1)
					+ ',' + lat + ',' + lon + ')">' + name + '<\/a><br>';
		} else if (color == "green") {
			greenColorPlaces += '<a class="placeData" style=color:' + color
					+ ' href="javascript:myclick(' + (gmarkers.length - 1)
					+ ',' + lat + ',' + lon + ')">' + name + '<\/a><br>';
		}

		side_bar_html += '<a class="placeData" style=color:' + color
				+ ' href="javascript:myclick(' + (gmarkers.length - 1) + ')">'
				+ name + '<\/a><br>';

		google.maps.event
				.addListener(
						marker,
						'click',
						function() {
							//alert("marker location");

							$('#imageData').css('display', 'block');
							var zipPopulation = marker.pop;
							xStoreData = getAllStoresInZip(zipcode);
							storeCodeArray = new Array();
							storeCodeArray = getStoreCodeFromJson(xStoreData);
						//	alert(storeCodeArray);
							/*
							 * Factor that divides the total population of the
							 * city to that of the number of retail stores in
							 * the city
							 */
							var bffForCity = marker.pop / storeCodeArray.length;
							html += bffForCity
									+ "<br/><input type='image' class='genLocationChart' onclick='generateRetailChart(this)' src='images/pie-chart-icon.png' alt='Generate Chart' style='width:30%'></h5></div>";
							var storeDetailArray = new Array();
							var obj = null;
							var storDetail;

							for (var i = 0; i < storeCodeArray.length; i++) {

								// alert(storeCodeArray[i]);
								storDetail = getStoreDetailsGivenStoreCode(storeCodeArray[i]);
								// alert('Before parsing');
								obj = $.parseJSON(storDetail);
								// alert(JSON.stringify(obj.StoreInfo.Characteristics[0].LATITUDE));
								storeDetailArray.push(obj);
								// alert(storeDetailArray);
								point = new GLatLng(
										obj.StoreInfo.Characteristics[0].LATITUDE,
										obj.StoreInfo.Characteristics[0].LONGITUDE);
								// alert(point);
								marker = createStoreMarker(
										point,
										"Sample",
										"<div style='width:100px;height:100px'><h5>"
												+ obj.StoreInfo.Characteristics[0].STORE_NAME
												+ "<br/>"
												+ obj.StoreInfo.Characteristics[0].TRADE_CHANNEL_CODE
												+ "<br></h5></div>",
										markerStoreOptions, "red")
								map.addOverlay(marker);
								storeMarkerArray.push(marker);
							}
							fetchStoreDetailArray(storeDetailArray,
									zipPopulation, marker);

						});
		GEvent.addListener(marker, "click", function() {
			marker.openInfoWindowHtml(html);
		});
		return marker;
	}



	function focusMarker(event, marker) {
		var countNumberOfRetailType = 0;
		var newBFF = null;
		map.setZoom(12);
		var categoryCode = $(event).find('a:first').text();
		var population = $(event).find('a:nth-child(2)').text();
		map.clearOverlays();
		for (var i = 0; i < retailTypes.length; i++) {
			if (retailTypes[i].type == categoryCode) {
				for (var j = 0; j < retailTypes[i].marker.length; j++) {
					countNumberOfRetailType++;
					map.addOverlay(retailTypes[i].marker[j]);
				}
			}
		}
		newBFF = population / countNumberOfRetailType;
		if (newBFF <= 5000) {
			newMarker = createStoreMarker(point, "Sample", "<h5>" + categoryCode
					+ "BFF :" + newBFF.toFixed(0) + "</h5><br/><input type='image' class='genRetailTypeChart' onclick='genRetailTypeChart(this)' src='images/pie-chart-icon.png' alt='Generate Chart' style='width:20%'>", markerRedOptions,
					"Red")
		} else if (newBFF > 5000 && newBFF <= 10000) {
			newMarker = createStoreMarker(point, "Sample", "<h5>" + categoryCode
					+ "BFF :" + newBFF.toFixed(0) + "</h5><br/><input type='image' class='genRetailTypeChart' onclick='genRetailTypeChart(this)' src='images/pie-chart-icon.png' alt='Generate Chart' style='width:20%'>",
					markerYellowOptions, "Red")
		} else if (newBFF > 10000) {
			newMarker = createStoreMarker(point, "Sample", "<h5>" + categoryCode
					+ "BFF :" + newBFF.toFixed(0) + "</h5><br/><input type='image' class='genRetailTypeChart' onclick='genRetailTypeChart(this)' src='images/pie-chart-icon.png' alt='Generate Chart' style='width:20%'>", markerGreenOptions,
					"Red")
		}
		point = new GLatLng(33.491278, -112.246763);
		map.setCenter(new GLatLng(33.491278, -112.246763), 12);
		map.addOverlay(newMarker);
	}

	/*
	 * $('#moreButton').click(function(){
	 * 
	 * window.location.href='graph.html?storeCodes='+storeCodeArray; });
	 */
	
	$('#refreshButton').click(function(){
		location.reload();
		
		
		
	});
	

	// This function picks up the click and opens the corresponding info window
	function myclick(i, lat, lon) {
		GEvent.trigger(gmarkers[i], "click");
		
	}

	// add the points
	/*
	 * var point = new GLatLng(35.889311, -101.090012); var marker =
	 * createMarker(point, "This place", "Some stuff to display in the<br>First
	 * Info Window") map.addOverlay(marker);
	 * 
	 * var point = new GLatLng(32.889311, -103.090012); var marker =
	 * createMarker(point, "That place", "Some stuff to display in the<br>Second
	 * Info Window") map.addOverlay(marker);
	 */

	/*
	 * var point = new GLatLng(-86.956435,33.465424); var marker =
	 * createMarker(point, "The other place", "Some stuff to display in the<br>Third
	 * Info Window") map.addOverl ay(marker);
	 */

	for (var i = 0; i < citiesArray.length; i++) {
		locTemp = citiesArray[i].loc;
		myZipCode = citiesArray[i]._id;
		point = new GLatLng(locTemp[1], locTemp[0]);
		bff = (citiesArray[i].pop / 15).toFixed(2);
		if (bff < 250) {
			marker = createMarker(point, citiesArray[i].city,
					"<div style='width:100px;height:100px'><h5>City:"
							+ citiesArray[i].city + "<br/>ZipCode:"
							+ citiesArray[i]._id + "<br/>BFF:",
					/*
					 * + citiesArray[i]._id + "<br><input type='image'
					 * class='genLocationChart'
					 * onclick='generateRetailChart(this)'
					 * src='images/pie-chart-icon.png' alt='Generate Chart'
					 * style='width:30%'></h5></div>",
					 */
					markerRedOptions, "red", locTemp[1], locTemp[0],
					citiesArray[i]._id, citiesArray[i].pop)
			redMarkersArray.push(marker);
			redCount++;
		} else if (bff > 250 && bff < 500) {
			marker = createMarker(point, citiesArray[i].city,
					"<div style='width:100px;height:100px'><h5>City:"
							+ citiesArray[i].city + "<br/>ZipCode:"
							+ citiesArray[i]._id + "<br/>BFF:",
					/*
					 * + citiesArray[i]._id + "<br><input type='image'
					 * class='genLocationChart'
					 * onclick='generateRetailChart(this)'
					 * src='images/pie-chart-icon.png' alt='Generate Chart'
					 * style='width:30%'></h5></div>",
					 */
					markerYellowOptions, "blue", locTemp[1], locTemp[0],
					citiesArray[i]._id, citiesArray[i].pop)
			yellowMarkersArray.push(marker);
			yellowCount++;
		} else if (bff > 500) {
			marker = createMarker(point, citiesArray[i].city,
					"<div style='width:100px;height:100px'><h5>City:"
							+ citiesArray[i].city + "<br/>ZipCode:"
							+ citiesArray[i]._id + "<br/>BFF:",
					/*
					 * + citiesArray[i]._id + "<br><input type='image'
					 * class='genLocationChart'
					 * onclick='generateRetailChart(this)'
					 * src='images/pie-chart-icon.png' alt='Generate Chart'
					 * style='width:30%'></h5></div>",
					 */
					markerGreenOptions, "green", locTemp[1], locTemp[0],
					citiesArray[i]._id, citiesArray[i].pop)
			greenMarkersArray.push(marker);
			greenCount++;

		}

		map.addOverlay(marker);

	}

	$('input.legend').click(function() {
		map.setCenter(new GLatLng(35.889311, -101.090012), 4);
		map.clearOverlays();
		legendSelected = $(this).attr('id');
		if (legendSelected == "redLegend") {
			for (var i = 0; i < redMarkersArray.length; i++) {
				map.addOverlay(redMarkersArray[i]);
			}
			document.getElementById("side_bar").innerHTML = redColorPlaces;
		}
		if (legendSelected == "yellowLegend") {
			for (var i = 0; i < yellowMarkersArray.length; i++) {
				map.addOverlay(yellowMarkersArray[i]);
			}
			document.getElementById("side_bar").innerHTML = yellowColorPlaces;
		}
		if (legendSelected == "greenLegend") {
			for (var i = 0; i < greenMarkersArray.length; i++) {
				map.addOverlay(greenMarkersArray[i]);
			}
			document.getElementById("side_bar").innerHTML = greenColorPlaces;
		}
	});

	function generateRetailChart(event) {
		//alert(JSON.stringify(storeCodeArray)+"  "+myZipCode);
		location.href = 'Chart.jsp?storeCode='+storeCodeArray+'&zipCode='+myZipCode;
	}
	
	
	function genRetailTypeChart(event)
	{
		
		var newArray = new Array();
		newArray.push(713855);
		newArray.push(1662246);
		newArray.push(1608562);
		location.href = 'Chart.jsp?storeCode='+newArray+'&zipCode='+myZipCode;
		
	}
	
	$('.genRetailTypeChart').click(function(){
		var newArray = new Array();
		newArray.push(713855);
		newArray.push(1662246);
		newArray.push(1608562);
		location.href = 'Chart.jsp?storeCode='+newArray+'&zipCode='+myZipCode;
		
		
		
		
	});
	
	/*
	 * -------------------------------------------------
	 */

	$('.genLocationChart').click(
			function() {
				location.href = 'Chart.jsp?storeCode='+storeCodeArray+'&zipCode='+myZipCode;
			});

	/*
	 * --------------------------------------------------
	 */
	

}

else {
	alert("Sorry, the Google Maps API is not compatible with this browser");
}

// This Javascript is based on code provided by the
// Community Church Javascript Team
// http://www.bisphamchurch.org.uk/
// http://econym.org.uk/gmap/

// ]]>

var specialElementHandlers = {

	'#editor' : function(element, renderer) { // alert('specialElementHandlers');
		return true;
	}
};

$('#generatePdf')
		.click(
				function() {
					var doc = new jsPDF();
					// doc.fromHTML($('#frame').html(), 15, 15, {'width': 170,
					// 'elementHandlers': specialElementHandlers });
					doc
							.text(
									30,
									20,
									'http://maps.googleapis.com/maps/api/staticmap?center=40.714728,-73.998672&zoom=12&size=256x256&format=jpg&sensor=false');
					// alert(doc+'>>'+doc.text());

					var c = document.getElementById("myCanvas");
					var ctx = c.getContext("2d");
					var img = document.getElementById("preview");
					ctx.drawImage(img, 10, 10);
					doc.output('datauri');
					// doc.save('Test.pdf');
				});

/*
 * fetchStoreDetailArray() to fetch the store array
 */
function fetchStoreDetailArray(objArr, zipPopulation, marker) {
	if (objArr != null || objArr != undefined) {
		retailTypeObject = new Object();
		retailTypeObject.type = "Retail";
		retailTypeObject.count = objArr.length;
		retailTypes.push(retailTypeObject);
		for (var i = 0; i < objArr.length; i++) {

			for (var j = 0; j < retailTypes.length; j++) {
				if (objArr[i].StoreInfo.Characteristics[0].TRADE_CHANNEL_CODE == retailTypes[j].type) {
					status = 1;
					retailTypes[j].count++;
					retailTypeObject.mainObject
							.push(objArr[i].StoreInfo.Characteristics[0]);
					retailTypeObject.marker.push(storeMarkerArray[i]);
					break;
				}

			}
			if (status == 0) {
				retailTypeObject = new Object();
				retailTypeObject.type = objArr[i].StoreInfo.Characteristics[0].TRADE_CHANNEL_CODE;
				retailTypeObject.count = 1;
				retailTypeObject.mainObject = new Array();
				retailTypeObject.marker = new Array();
				retailTypeObject.mainObject
						.push(objArr[i].StoreInfo.Characteristics[0]);
				retailTypeObject.marker.push(storeMarkerArray[i]);
				retailTypes.push(retailTypeObject);
			}
			status = 0;
		}

	}
		
		
		
		if(page=='home')
	       {
	               side_bar_html="<fieldset><legend>Select specific trade channel</legend>";
	               side_bar_html += '<ul><button class="nanButton"><a href="#">' + retailTypes[0].type + '<\/a></button> <br/>';
	               side_bar_html+='<br/>';
	               for (var i = 1; i < retailTypes.length; i++) {
	                       side_bar_html += '<li><button class="nanButton" onclick="focusMarker(this,marker)" ><label><a  href="#" >'
	                                       + retailTypes[i].type + '<\/a><a style="display:none" href="#">' +zipPopulation+'<\/a><\/button></li>';
	                       side_bar_html+='<br/>';
	               }

	               side_bar_html += '<\/ul></fieldset>';
	               document.getElementById("side_bar").innerHTML = side_bar_html;
	       }
	       return retailTypes;
	
}


